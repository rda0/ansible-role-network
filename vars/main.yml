_network_ipv4_ip: "{{ globalvars[inventory_hostname]['ipv4'] }}"
_network_ipv4_subnet: "{{ globalvars[inventory_hostname]['ipv4_subnet'] }}"
_network_ipv4_prefixlen: "{{ globalvars_subnets[_network_ipv4_subnet]['prefixlen'] }}"
_network_ipv4_address: '{{ _network_ipv4_ip }}/{{ _network_ipv4_prefixlen }}'
_network_ipv4_gateway: "{{ globalvars_subnets[_network_ipv4_subnet]['gateway_address'] }}"
_network_has_ipv6: "{{ True if 'ipv6' in globalvars[inventory_hostname] else False }}"
_network_ipv6_ip: "{{ globalvars[inventory_hostname]['ipv6'] | default('') }}"
_network_ipv6_subnet: "{{ globalvars[inventory_hostname]['ipv6_subnet'] | default('') }}"
_network_ipv6_prefixlen: "{{ globalvars_subnets[_network_ipv6_subnet]['prefixlen'] | default('') }}"
_network_ipv6_address: '{{ _network_ipv6_ip }}/{{ _network_ipv6_prefixlen }}'
_network_ipv6_gateway: "{{ globalvars_subnets[_network_ipv6_subnet]['gateway_address'] | default('') }}"
_network_ipv6_ra: "{% if not network_systemd_ipv6_accept_ra %}IPv6AcceptRA=false{% endif %}"

network_systemd_host_address_params:
  - "Address={{ _network_ipv4_address }}"
  - "Gateway={{ _network_ipv4_gateway }}"
  - '{% if network_systemd_dns_ipv4 and not network_systemd_resolved_global_dns %}DNS={{ network_systemd_dns_ipv4 }}{% endif %}'
  - '{% if not network_systemd_resolved_global_dns %}Domains={{ network_systemd_domains }}{% endif %}'
  - "{% if _network_has_ipv6 %}Address={{ _network_ipv6_address }}{% endif %}"
  - "{% if _network_has_ipv6 and (network_systemd_ipv6_static_gateway or not network_systemd_ipv6_accept_ra) %}Gateway={{ _network_ipv6_gateway }}{% endif %}"
  - '{{ _network_ipv6_ra }}'
  - "{% if _network_has_ipv6 and network_systemd_dns_ipv6 and not network_systemd_resolved_global_dns %}DNS={{ network_systemd_dns_ipv6 }}{% endif %}"

network_systemd_network_templates:
  default_dhcp:
    - name: host
      sections:
      - name: Match
        params: ['Name={{ network_interface }}']
      - name: Network
        params:
          - 'DHCP=ipv4'
          - 'Domains={{ network_systemd_domains }}'
          - '{{ _network_ipv6_ra }}'
      - name: DHCP
        params:
          - 'UseDomains=true'
          - 'UseNTP=true'
  default_static:
    - name: host
      sections:
      - name: Match
        params: ['Name={{ network_interface }}']
      - name: Network
        params: '{{ network_systemd_host_address_params }}'
  bridge_static:
    - name: '{{ network_interface }}'
      sections:
      - name: Match
        params: ['Name={{ network_interface }}']
      - name: Network
        params:
          - "Bridge={{ network_bridges[0]['name'] | default('') }}"
          - '{{ _network_ipv6_ra }}'
    - name: "{{ network_bridges[0]['name'] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bridges[0]['name'] | default('') }}"]
      - name: Network
        params: '{{ network_systemd_host_address_params }}'
  bond_static:
    - name: "{{ network_bond['interfaces'][0] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['interfaces'][0] | default('') }}"]
      - name: Network
        params:
          - "Bond={{ network_bond['name'] | default('') }}"
          - '{{ _network_ipv6_ra }}'
    - name: "{{ network_bond['interfaces'][1] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['interfaces'][1] | default('') }}"]
      - name: Network
        params:
          - "Bond={{ network_bond['name'] | default('') }}"
          - '{{ _network_ipv6_ra }}'
    - name: "{{ network_bond['name'] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['name'] | default('') }}"]
      - name: Network
        params: "{{ network_systemd_host_address_params + [''.join(['BindCarrier=', network_bond['interfaces'][0] | default(''), ' ', network_bond['interfaces'][1] | default('')])] }}"
  bond_2vlans_2bridges:
    - name: "{{ '' if network_interface in network_bridges | map(attribute='name') | flatten else 'host' }}"
      sections:
      - name: Match
        params: ['Name={{ network_interface }}']
      - name: Network
        params: '{{ network_systemd_host_address_params }}'
    - name: "{{ network_bond['interfaces'][0] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['interfaces'][0] | default('') }}"]
      - name: Network
        params:
          - "Bond={{ network_bond['name'] | default('') }}"
          - '{{ _network_ipv6_ra }}'
    - name: "{{ network_bond['interfaces'][1] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['interfaces'][1] | default('') }}"]
      - name: Network
        params:
          - "Bond={{ network_bond['name'] | default('') }}"
          - '{{ _network_ipv6_ra }}'
    - name: "{{ network_bond['name'] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['name'] | default('') }}"]
      - name: Network
        params:
          - "BindCarrier={{ network_bond['interfaces'][0] | default('') }} {{ network_bond['interfaces'][1] | default('') }}"
          - "VLAN={{ network_vlans['vlans'][0]['name'] | default('') }}"
          - "VLAN={{ network_vlans['vlans'][1]['name'] | default('') }}"
          - '{{ _network_ipv6_ra }}'
    - name: "{{ network_vlans['vlans'][0]['name'] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_vlans['vlans'][0]['name'] | default('') }}"]
      - name: Network
        params:
          - "Bridge={{ network_bridges[0]['name'] | default('') }}"
          - '{{ _network_ipv6_ra }}'
    - name: "{{ network_vlans['vlans'][1]['name'] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_vlans['vlans'][1]['name'] | default('') }}"]
      - name: Network
        params:
          - "Bridge={{ network_bridges[1]['name'] | default('') }}"
          - '{{ _network_ipv6_ra }}'
    - name: "{{ network_bridges[0]['name'] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bridges[0]['name'] | default('') }}"]
      - name: Network
        params: "{{ network_systemd_host_address_params if network_interface in network_bridges | map(attribute='name') | flatten else ['IPv6AcceptRA=false'] }}"
    - name: "{{ network_bridges[1]['name'] | default('') }}"
      sections:
      - name: Match
        params: ["Name={{ network_bridges[1]['name'] | default('') }}"]
      - name: Network
        params: ['IPv6AcceptRA=false']

network_systemd_netdev_templates:
  default_dhcp: []
  default_static: []
  bridge_static:
    - name: "{{ network_bridges[0]['name'] | default('') }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bridges[0]['name'] | default('') }}"
          - 'Kind=bridge'
      - name: Bridge
        params: ['STP=off']
  bond_static:
    - name: "{{ network_bond['name'] | default('') }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bond['name'] | default('') }}"
          - 'Kind=bond'
      - name: Bond
        params:
          - 'Mode=802.3ad'
          - 'TransmitHashPolicy=layer3+4'
          - 'MIIMonitorSec=1s'
          - 'LACPTransmitRate=fast'
  bond_2vlans_2bridges:
    - name: "{{ network_bond['name'] | default('') }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bond['name'] | default('') }}"
          - 'Kind=bond'
      - name: Bond
        params:
          - 'Mode=802.3ad'
          - 'TransmitHashPolicy=layer3+4'
          - 'MIIMonitorSec=1s'
          - 'LACPTransmitRate=fast'
    - name: "{{ network_vlans['vlans'][0]['name'] | default('') }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_vlans['vlans'][0]['name'] | default('') }}"
          - 'Kind=vlan'
      - name: VLAN
        params: ["Id={{ network_vlans['vlans'][0]['id'] | default('') }}"]
    - name: "{{ network_vlans['vlans'][1]['name'] | default('') }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_vlans['vlans'][1]['name'] | default('') }}"
          - 'Kind=vlan'
      - name: VLAN
        params: ["Id={{ network_vlans['vlans'][1]['id'] | default('') }}"]
    - name: "{{ network_bridges[0]['name'] | default('') }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bridges[0]['name'] | default('') }}"
          - 'Kind=bridge'
      - name: Bridge
        params: ['STP=off']
    - name: "{{ network_bridges[1]['name'] | default('') }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bridges[1]['name'] | default('') }}"
          - 'Kind=bridge'
      - name: Bridge
        params: ['STP=off']

network_systemd_link_templates:
  default: []
  name_policy:
    - name: '90-name-policy'
      sections:
      - name: Match
        params: ['OriginalName=*']
      - name: Link
        params:
          - 'NamePolicy={{ network_systemd_link_name_policy }}'
          - 'AlternativeNamesPolicy={{ network_systemd_link_alternative_name_policy }}'
          - 'MACAddressPolicy=persistent'
  name_policy_ethernet:
    - name: '90-name-policy-ethernet'
      sections:
      - name: Match
        params: ['Type=ether']
      - name: Link
        params:
          - 'NamePolicy={{ network_systemd_link_name_policy }}'
          - 'AlternativeNamesPolicy={{ network_systemd_link_alternative_name_policy }}'
          - 'MACAddressPolicy=persistent'
