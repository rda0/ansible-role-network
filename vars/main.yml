network_systemd_domains: phys.ethz.ch ethz.ch
network_systemd_dns_ipv4: 129.132.98.12
network_systemd_dns_ipv6: 2001:67c:10ec::c

network_systemd_host_address_params:
  - "Address={{ globalvars[inventory_hostname]['ipv4'] }}/{{ globalvars_subnets[globalvars[inventory_hostname]['ipv4_subnet']]['prefixlen'] }}"
  - "Gateway={{ globalvars_subnets[globalvars[inventory_hostname]['ipv4_subnet']]['gateway_address'] }}"
  - 'DNS={{ network_systemd_dns_ipv4 }}'
  - 'Domains={{ network_systemd_domains }}'
  - "{% if 'ipv6' in globalvars[inventory_hostname] %}Address={{ globalvars[inventory_hostname]['ipv6'] }}/{{ globalvars_subnets[globalvars[inventory_hostname]['ipv6_subnet']]['prefixlen'] }}{% endif %}"
  - "{% if 'ipv6' in globalvars[inventory_hostname] %}DNS={{ network_systemd_dns_ipv6 }}{% endif %}"

network_systemd_network_templates:
  default_dhcp:
    - name: en
      sections:
      - name: Match
        params: ['Name={{ network_interface }}']
      - name: Network
        params: ['DHCP=ipv4', 'Domains={{ network_systemd_domains }}']
      - name: DHCP
        params: ['UseDomains=true', 'UseNTP=true']
  default_static:
    - name: '{{ network_interface }}'
      sections:
      - name: Match
        params: ['Name={{ network_interface }}']
      - name: Network
        params: '{{ network_systemd_host_address_params }}'
  bridge_static:
    - name: '{{ network_interface }}'
      sections:
      - name: Match
        params: ['Name={{ network_interface }}']
      - name: Network
        params: ["Bridge={{ network_bridges[0]['name'] }}"]
    - name: "{{ network_bridges[0]['name'] }}"
      sections:
      - name: Match
        params: ["Name={{ network_bridges[0]['name'] }}"]
      - name: Network
        params: '{{ network_systemd_host_address_params }}'
  bond_2vlans_2bridges:
    - name: "{{ '' if network_interface in network_bridges|map(attribute='name')|flatten else 'host' }}"
      sections:
      - name: Match
        params: ['Name={{ network_interface }}']
      - name: Network
        params: '{{ network_systemd_host_address_params }}'
    - name: "{{ network_bond['interfaces'][0] }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['interfaces'][0] }}"]
      - name: Network
        params: ["Bond={{ network_bond['name'] }}"]
    - name: "{{ network_bond['interfaces'][1] }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['interfaces'][1] }}"]
      - name: Network
        params: ["Bond={{ network_bond['name'] }}"]
    - name: "{{ network_bond['name'] }}"
      sections:
      - name: Match
        params: ["Name={{ network_bond['name'] }}"]
      - name: Network
        params:
          - "BindCarrier={{ network_bond['interfaces'][0] }} {{ network_bond['interfaces'][1] }}"
          - "VLAN={{ network_vlans['vlans'][0]['name'] }}"
          - "VLAN={{ network_vlans['vlans'][1]['name'] }}"
    - name: "{{ network_vlans['vlans'][0]['name'] }}"
      sections:
      - name: Match
        params: ["Name={{ network_vlans['vlans'][0]['name'] }}"]
      - name: Network
        params: ["Bridge={{ network_bridges[0]['name'] }}"]
    - name: "{{ network_vlans['vlans'][1]['name'] }}"
      sections:
      - name: Match
        params: ["Name={{ network_vlans['vlans'][1]['name'] }}"]
      - name: Network
        params: ["Bridge={{ network_bridges[1]['name'] }}"]
    - name: "{{ network_bridges[0]['name'] }}"
      sections:
      - name: Match
        params: ["Name={{ network_bridges[0]['name'] }}"]
      - name: Network
        params: "{{ network_systemd_host_address_params if network_interface in network_bridges|map(attribute='name')|flatten else ['IPv6AcceptRA=false'] }}"
    - name: "{{ network_bridges[1]['name'] }}"
      sections:
      - name: Match
        params: ["Name={{ network_bridges[1]['name'] }}"]
      - name: Network
        params: ['IPv6AcceptRA=false']

network_systemd_netdev_templates:
  default_dhcp: []
  default_static: []
  bridge_static:
    - name: "{{ network_bridges[0]['name'] }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bridges[0]['name'] }}"
          - 'Kind=bridge'
      - name: Bridge
        params: ['STP=off']
  bond_2vlans_2bridges:
    - name: "{{ network_bond['name'] }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bond['name'] }}"
          - 'Kind=bond'
      - name: Bond
        params:
          - 'Mode=802.3ad'
          - 'TransmitHashPolicy=layer3+4'
          - 'MIIMonitorSec=1s'
          - 'LACPTransmitRate=fast'
    - name: "{{ network_vlans['vlans'][0]['name'] }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_vlans['vlans'][0]['name'] }}"
          - 'Kind=vlan'
      - name: VLAN
        params: ["Id={{ network_vlans['vlans'][0]['id'] }}"]
    - name: "{{ network_vlans['vlans'][1]['name'] }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_vlans['vlans'][1]['name'] }}"
          - 'Kind=vlan'
      - name: VLAN
        params: ["Id={{ network_vlans['vlans'][1]['id'] }}"]
    - name: "{{ network_bridges[0]['name'] }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bridges[0]['name'] }}"
          - 'Kind=bridge'
      - name: Bridge
        params: ['STP=off']
    - name: "{{ network_bridges[1]['name'] }}"
      sections:
      - name: NetDev
        params:
          - "Name={{ network_bridges[1]['name'] }}"
          - 'Kind=bridge'
      - name: Bridge
        params: ['STP=off']
